# 应用网络集群学习

### 玉带：实现了集群间pod的通信

![image-20231126172740152](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126172740152.png)

#### 整体架构：

![](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126154615924.png)

租户集群里的route agt把跨集群流量从集群导入到AGW

一个站点内的所有集群事件通过写入AGW的apisvr再通过opt上报给global

AGW的数据面里的agent负责配置路由 

![image-20231127114512012](C:\Users\y50037703\AppData\Roaming\Typora\typora-user-images\image-20231127114512012.png)

### 控制面：负责系统的配置管理和决策制定

![image-20231126154151211](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126154151211.png)

以集群1（租户k8s集群3可以访问到其服务为例

下面是服务跨集群访问的前置步骤：

1. **服务发布**：
   - 在集群1中，服务被发布并创建了相应的 `ServiceExport` 对象。
2. **服务发现同步到站点AGW**：
   - 集群1内的 `ENS-AN-tenant-operator`   服务监控到 `ServiceExport` 资源的变化，并将发布服务相关的 `EndpointSlice` 信息同步到站点1的 AGW 中的 `ENS-k8s-Api-server`。
3. **站点AGW同步到全局服务**：
   - 站点1的 AGW 中的 `ENS-AN-Local-Operator` 服务监控到 `ENS-k8s-Api-server` 中资源的变化，并将 `EndpointSlice` 信息同步到全局的 `ENS-AN-Global-Service`，同时保存到数据库。
4. **全局服务同步到其他站点AGW**：
   - 全局的 `ENS-AN-Global-Service` 根据业务需求将站点1同步上来的 `EndpointSlice` 信息以及与发布服务关联的 `ServiceImport` 同步到集群3所在的站点2的 AGW 的 `ENS-k8s-Api-server` 中。
5. **站点AGW同步到目标集群**：
   - 站点2中的 AGW 的 `ENS-AN-Local-Operator` 监控 AGW 中的 `ENS-k8s-Api-server`，将 `ServiceImport` 同步到集群3的 `ENS-k8s-Api-server` 中。



### 数据面：负责处理和转发数据

![image-20231126154220495](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126154220495.png)

通过路由配置，打通跨集群间的网络，使数据报文可以从请求Pod出发到达目的Pod

gatewayCIDR和proxyCIDR不能和k8s集群的podCDIR重叠

#### **流量的一般流程**：

- **Pod 到 Node**：Pod 发出的流量首先通过节点（Node）上的网络接口传输。
- **Node 到路由器**：然后，流量通过集群网络路由到物理或虚拟路由器。
- **路由器到 AGW**：路由器将流量导向 AGW。
- AGW 分发
  - 如果目标 Pod 位于同一站点，AGW 的 VLAN 接口将处理流量。
  - 如果目标 Pod 位于不同站点，AGW 的 VXLAN 接口将处理流量，并将其封装以跨越站点间的网络。

路由配置主要分为集群路由、交换机路由和AGW路由三部分

#### 集群路由：

集群路由主要实现请求和响应报文从K8S集群中正确路由到交换机上。

**请求报文**：

源地址：节点eth0 目的地址：envoy监听的gateway ip（从gatewayCIDR中分配）。下一跳：交换机接口地址



![image (2)](C:\Users\y50037703\Pictures\新建文件夹\数据面设计\image (2).png)



- **响应报文**：请求报文在通过源端AGW后会做FullNat，其源IP会根据互访上游k8s集群和本集群的部署形态分为两种情况

1. 互访的集群如果在同一个站点，报文请求经过FullNat的源IP为vlanIf的地址，由于vlanIf地址和k8s集群的地址同网段，所以响应报文时无须添加新路由。
2. 互访的集群如果在不同的站点，报文请求经过FullNat的源IP为vxlan的地址（proxyCIDR中分配），所以响应报文时需要将请求proxyCIDR这个网段的报文路由到k8s_gateway。

![3](C:\Users\y50037703\Pictures\新建文件夹\数据面设计\3.png)





#### 交换机路由：

交换机路由主要实现请求中从交换机路由到AGW节点，需要运维人员到交换机上进行配置。

![cf10fac8c8e2d9a09c5337cd80bdcc1985855780](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\cf10fac8c8e2d9a09c5337cd80bdcc1985855780.png)

- **请求报文**：由Pod发出的请求报文通过上面的集群路由，将报文转发到交换机后，由于AGW集群通常有多个AGW节点，故需要通过ECMP，将请求等价转发到不同的AGW节点（vlanif接口和k8s集群同网段）。

![image (4)](C:\Users\y50037703\Pictures\新建文件夹\数据面设计\image (4).png)



- **响应报文**：由Pod发出的响应报文通过上面的集群路由，将报文转发到交换机，同样需要通过ECMP，将请求等价转发到不同的AGW节点。

![image (5)](C:\Users\y50037703\Pictures\新建文件夹\数据面设计\image (5).png)

- **VXLAN隧道路由**

由于我们跨站点通过在AGW集群之间创建vxlan隧道进行通信，每个AGW集群有多个AGW节点，所以AGW之间数据转发需要在交换机上做ECMP。

![image (6)](C:\Users\y50037703\Pictures\新建文件夹\数据面设计\image (6).png)

#### AGW路由

由于发送方不关注具体的对端pod，关注的是服务，而服务再发布时，所关联的pod，ip，端口就已经在envoy上

![image-20231127172706086](C:\Users\y50037703\AppData\Roaming\Typora\typora-user-images\image-20231127172706086.png)

疑问：

玉带是不是就是实现了用户集群之间的通信

AGW怎么理解？gatewaycidr?

应用网关（AGW，Application Gateway）是一种网络安全设备，它在应用层（第七层）工作，提供高级的流量管理功能和安全性控制。不同于传统的网络层网关，应用网关更加关注于特定应用协议的内容和行为。

↑是这个吗，还是说，AGW和集群是同一级的，集群中的节点的网络信息要先通过交换机到达AGW，envoy作为AGW的代理

![image-20231126181320996](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126181320996.png)

TOR是什么？

AA再解释一下

![image-20231126195441922](C:\Users\y50037703\Downloads\codes-master\codes-master\应用网络\新建文件夹\image-20231126195441922.png)

↑解释下gatewayCIDR，两个AGW监听的地址是同一个CIDR吗?路由规则里，是否只要是目的地址在CIDR范围内的都会下一跳到指定的vlanif





