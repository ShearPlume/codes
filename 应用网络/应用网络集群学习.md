# 应用网络集群学习

### 玉带：实现了集群间pod的通信

![image-20231126172740152](\新建文件夹\image-20231126172740152.png)

#### 整体架构：

![image-20231126154615924](\新建文件夹\image-20231126154615924.png)

### 控制面：负责系统的配置管理和决策制定

![image-20231126154151211](\新建文件夹\image-20231126154151211.png)

以集群1（可以访问到租户k8s集群3的服务为例

下面是服务跨集群访问的前置步骤：

1. **服务发布**：
   - 在集群1中，服务被发布并创建了相应的 `ServiceExport` 对象。
2. **服务发现同步到站点AGW**：
   - 集群1内的 `ENS-AN-tenant-operator` 服务监控到 `ServiceExport` 资源的变化，并将发布服务相关的 `EndpointSlice` 信息同步到站点1的 AGW 中的 `ENS-k8s-Api-server`。
3. **站点AGW同步到全局服务**：
   - 站点1的 AGW 中的 `ENS-AN-Local-Operator` 服务监控到 `ENS-k8s-Api-server` 中资源的变化，并将 `EndpointSlice` 信息同步到全局的 `ENS-AN-Global-Service`，同时保存到数据库。
4. **全局服务同步到其他站点AGW**：
   - 全局的 `ENS-AN-Global-Service` 根据业务需求将站点1同步上来的 `EndpointSlice` 信息以及与发布服务关联的 `ServiceImport` 同步到集群3所在的站点2的 AGW 的 `ENS-k8s-Api-server` 中。
5. **站点AGW同步到目标集群**：
   - 站点2中的 AGW 的 `ENS-AN-Local-Operator` 监控 AGW 中的 `ENS-k8s-Api-server`，将 `ServiceImport` 同步到集群3的 `ENS-k8s-Api-server` 中。

![image-20231126203757617](\新建文件夹\image-20231126203757617.png)

### 数据面：负责处理和转发数据

![image-20231126154220495](\新建文件夹\image-20231126154220495.png)

通过路由配置，打通跨集群间的网络，使数据报文可以从请求Pod出发到达目的Pod

**流量的一般流程**：

- **Pod 到 Node**：Pod 发出的流量首先通过节点（Node）上的网络接口传输。
- **Node 到路由器**：然后，流量通过集群网络路由到物理或虚拟路由器。
- **路由器到 AGW**：路由器将流量导向 AGW。
- AGW 分发
  - 如果目标 Pod 位于同一站点，AGW 的 VLAN 接口将处理流量。
  - 如果目标 Pod 位于不同站点，AGW 的 VXLAN 接口将处理流量，并将其封装以跨越站点间的网络。

路由配置主要分为集群路由、交换机路由和AGW路由三部分

集群路由：集群路由主要实现请求和响应报文从K8S集群中正确路由到交换机上。

![img](\新建文件夹\cf10fac8c8e2d9a09c5337cd80bdcc1985855780.png)





创建和使用CRD的基本步骤通常包括：

- **定义CRD**：创建一个CRD的YAML定义文件，其中包含了新资源的名称、版本、作用域和验证规则。
- **创建CRD**：使用`ku bectl apply -f`命令来在集群中创建CRD。
- **使用CRD**：一旦CRD在集群中创建，就可以像使用Kubernetes的原生资源那样创建、获取、更新和删除自定义资源。

CRD为Kubernetes用户提供了一个强大的工具，以适应多变的业务需求和工作负载，并在不改变核心Kubernetes代码的前提下，增强和自定义其功能。

ClusterRoute就是一个CRD实例：

```json
# gatewayCIDR和proxyCIDR对应的name不一样
{
    "apiVersion": "an.ens/v1",
    "kind": "ClusterRoute",
    "metadata": {
        "uid": "2609ec92-ac19-4467-a527-7f9e690e7836",
        "name": "",                     // ${clusterName}_gateway_cidr_route 或 ${clusterName}_proxy_cidr_route
        "namespace": "集群组namespace"
    },
    "spec": {
        "destination": "50.0.5.0/24",
        "nexthop": "195.0.1.1",         // k8s cluster在交换机上的网关地址, 每个集群不一样, 在页面进行配置.
        "clusterName": "cluster01",
    }
}
```

ClusterRoute由an-global-service调用AA接口下发

![img](\新建文件夹\c5bacc4568f64064a05ca04debaec1bf.png)



疑问：

玉带是不是就是实现了用户集群之间的通信

AGW怎么理解？

应用网关（AGW，Application Gateway）是一种网络安全设备，它在应用层（第七层）工作，提供高级的流量管理功能和安全性控制。不同于传统的网络层网关，应用网关更加关注于特定应用协议的内容和行为。

↑是这个吗，还是说，AGW和集群是同一级的，集群中的节点的网络信息要先通过交换机到达AGW，envoy作为AGW的代理

![image-20231126181320996](C:\Users\18309\Documents\应用网络\新建文件夹\image-20231126181320996.png)

TOR是什么？

AA再解释一下

![image-20231126195441922](C:\Users\18309\Documents\应用网络\新建文件夹\image-20231126195441922.png)

↑解释下gatewayCIDR，两个AGW监听的地址是同一个CIDR吗?路由规则里，是否只要是目的地址在CIDR范围内的都会下一跳到指定的vlanif





